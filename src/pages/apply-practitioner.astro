---
import { getBasePath } from '../lib/paths';
const basePath = getBasePath();
import Layout from '../components/Layout.astro';
import AuthenticatedForm from '../components/AuthenticatedForm.tsx';
import { getCollection } from 'astro:content';

// Get all services from the catalog (exclude resources)
const allServices = await getCollection('services');
const services = allServices.filter(s => s.data.type === 'service');
const serviceCategories = [...new Set(services.map(s => s.data.service_category || 'Other'))].sort();
---

<Layout title="Apply to be an Practitioner - OSS Wishlist" description="Join our community of verified open source practitioners. Help projects succeed while building your professional network.">
  <AuthenticatedForm client:load formType="practitioner application">
  <section class="py-16 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-6">
          Sign up as an <span class="text-gray-600">Open Source  Practitioner</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Join our community of verified practitioners and help open source projects thrive. 
          Connect with maintainers who need your expertise.
        </p>
      </div>

      <!-- Benefits Section -->
      <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-8 mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Why Join Our Practitioner Community?</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="text-center">
            <h3 class="font-semibold text-gray-900 mb-2">Connect with opportunity</h3>
            <p class="text-sm text-gray-700">Connect with projects that need your specific skills and get paid for your expertise.</p>
          </div>
          <div class="text-center">
            <h3 class="font-semibold text-gray-900 mb-2">Build Reputation</h3>
            <p class="text-sm text-gray-700">Showcase your expertise and build credibility in the open source community.</p>
          </div>
          <div class="text-center">
            <h3 class="font-semibold text-gray-900 mb-2">Give Back</h3>
            <p class="text-sm text-gray-700">Help open source projects overcome challenges, and  improve the sustainability of the ecosystem</p>
          </div>
        </div>
      </div>

    <!-- Application Form -->
    <div class="bg-white rounded-lg shadow-sm border p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Practitioner Application</h2>
      
      <form id="practitionerApplicationForm" class="space-y-6">
        <!-- Personal Information -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
            <input 
              type="text" 
              id="fullName" 
              name="fullName" 
              required 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="Your full name"
            />
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="your@email.com"
            />
          </div>
        </div>

        <!-- Professional Info -->
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Professional Title *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            required 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
            placeholder="e.g., Senior Software Engineer, Community Manager, Security Consultant"
          />
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="company" class="block text-sm font-medium text-gray-700 mb-2">Current Company/Organization</label>
            <input 
              type="text" 
              id="company" 
              name="company" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="Your current employer or 'Independent'"
            />
          </div>
          <div>
            <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Location</label>
            <input 
              type="text" 
              id="location" 
              name="location" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="City, Country or Remote"
            />
          </div>
        </div>

        <!-- Experience -->
        <div class="grid md:grid-cols-1 gap-6">
          <div>
            <label for="experience" class="block text-sm font-medium text-gray-700 mb-2">Years of Experience</label>
            <select 
              id="experience" 
              name="experience" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select experience level</option>
              <option value="0-2">0-2 years</option>
              <option value="2-5">2-5 years</option>
              <option value="5-8">5-8 years</option>
              <option value="8-12">8-12 years</option>
              <option value="12+">12+ years</option>
            </select>
          </div>
        </div>        <!-- Expertise Areas -->
        <div>
          <label for="specialties" class="block text-sm font-medium text-gray-700 mb-2">Areas of Expertise *</label>
          <p class="text-xs text-gray-500 mb-3">Select the services from our catalog that match your expertise</p>
          <div class="grid md:grid-cols-2 gap-3 mb-3">
            {services.map((service) => (
              <label class="flex items-start" key={service.slug}>
                <input type="checkbox" name="specialties" value={service.data.title} class="mr-2 rounded mt-1" />
                <span class="text-sm">
                  {service.data.title}
                  {service.data.service_category && (
                    <span class="text-xs text-gray-500 block">({service.data.service_category})</span>
                  )}
                </span>
              </label>
            ))}
          </div>
          <textarea 
            id="otherSpecialties" 
            name="otherSpecialties" 
            rows="2" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
            placeholder="Other specialties not listed above..."
          ></textarea>
        </div>

        <!-- Bio -->
        <div>
          <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">Professional Bio *</label>
          <textarea 
            id="bio" 
            name="bio" 
            required 
            rows="4" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
            placeholder="Tell us about your background, experience, and what makes you a great practitioner for our network (2-3 sentences)..."
          ></textarea>
        </div>

        <!-- Social/Contact -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="github" class="block text-sm font-medium text-gray-700 mb-2">GitHub Username</label>
            <input 
              type="text" 
              id="github" 
              name="github" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="yourusername"
            />
            <p class="text-xs text-gray-500 mt-1">For GitHub Sponsors integration</p>
          </div>
          <div>
            <label for="linkedin" class="block text-sm font-medium text-gray-700 mb-2">LinkedIn Profile</label>
            <input 
              type="url" 
              id="linkedin" 
              name="linkedin" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="https://linkedin.com/in/yourprofile"
            />
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="mastodon" class="block text-sm font-medium text-gray-700 mb-2">Mastodon Profile</label>
            <input 
              type="url" 
              id="mastodon" 
              name="mastodon" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="https://mastodon.social/@yourusername"
            />
          </div>
          <div>
            <label for="website" class="block text-sm font-medium text-gray-700 mb-2">Website/Portfolio</label>
            <input 
              type="url" 
              id="website" 
              name="website" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              placeholder="https://yourwebsite.com"
            />
          </div>
        </div>

        <!-- Notable Projects -->
        <div>
          <label for="projects" class="block text-sm font-medium text-gray-700 mb-2">Notable Open Source Projects</label>
          <textarea 
            id="projects" 
            name="projects" 
            rows="3" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
            placeholder="List notable open source projects you've contributed to, maintained, or founded..."
          ></textarea>
        </div>

        <!-- Availability -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="availability" class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
            <select 
              id="availability" 
              name="availability" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="available">Available immediately</option>
              <option value="limited">Limited availability</option>
              <option value="project-based">Project-based only</option>
              <option value="future">Available in future</option>
            </select>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="proBono" name="proBono" class="mr-2 rounded">
            <label for="proBono" class="text-sm text-gray-700">I accept pro bono cases in some situations</label>
          </div>
          
          <!-- Pro Bono Criteria - conditionally shown -->
          <div id="proBonoCriteria" class="mt-4 hidden space-y-4">
            <div>
              <label for="proBonoCapacity" class="block text-sm font-medium text-gray-700 mb-2">
                Pro Bono Capacity Per Month *
              </label>
              <input 
                type="number" 
                id="proBonoCapacity" 
                name="proBonoCapacity" 
                min="1" 
                max="10"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                placeholder="e.g., 2"
              />
              <p class="text-xs text-gray-500 mt-1">How many pro bono contracts are you willing to take per month?</p>
            </div>
            
            <div>
              <label for="proBonoCriteriaText" class="block text-sm font-medium text-gray-700 mb-2">Pro Bono Criteria</label>
              <textarea 
                id="proBonoCriteriaText" 
                name="proBonoCriteriaText" 
                rows="3" 
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Please describe the criteria for cases where you would accept pro bono work (e.g., non-profit organizations, solo maintainers, specific project types, etc.)"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Additional Info -->
        <div>
          <label for="additionalInfo" class="block text-sm font-medium text-gray-700 mb-2">Additional Information</label>
          <textarea 
            id="additionalInfo" 
            name="additionalInfo" 
            rows="3" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
            placeholder="Anything else you'd like us to know? Certifications, languages, preferred project types, etc."
          ></textarea>
        </div>

        <!-- Submit Button -->
        <div class="text-center pt-6">
          <button 
            type="submit"
            class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
          >
            Submit Practitioner Application
          </button>
        </div>

        <div class="text-sm text-gray-600 text-center">
          <p>By submitting this form, you agree to be contacted about joining our practitioner network. We'll review your application and get back to you within 5-7 business days.</p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Handle pro bono criteria visibility
    document.addEventListener('DOMContentLoaded', function() {
      const proBonoCheckbox = document.getElementById('proBono');
      const proBonoCriteriaDiv = document.getElementById('proBonoCriteria');
      const proBonoCapacityInput = document.getElementById('proBonoCapacity');
      
      proBonoCheckbox.addEventListener('change', function() {
        if (this.checked) {
          proBonoCriteriaDiv.classList.remove('hidden');
          // Make pro bono capacity required when checked
          proBonoCapacityInput.setAttribute('required', 'required');
        } else {
          proBonoCriteriaDiv.classList.add('hidden');
          document.getElementById('proBonoCriteriaText').value = '';
          proBonoCapacityInput.value = '';
          // Remove required attribute when unchecked
          proBonoCapacityInput.removeAttribute('required');
        }
      });
    });

    // Handle form submission
    document.getElementById('practitionerApplicationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      // Collect selected specialties
      const specialties = Array.from(document.querySelectorAll('input[name="specialties"]:checked'))
        .map(cb => cb.value);
      data.specialties = specialties;
      
      try {
        // Submit practitioner application via API (sends email to admin)
        const response = await fetch('/oss-wishlist-website/api/submit-practitioner', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            fullName: data.fullName,
            email: data.email,
            title: data.title,
            company: data.company,
            location: data.location,
            experience: data.experience,
            specialties: specialties,
            otherSpecialties: data.otherSpecialties,
            bio: data.bio,
            github: data.github,
            linkedin: data.linkedin,
            mastodon: data.mastodon,
            website: data.website,
            projects: data.projects,
            availability: data.availability,
            proBono: data.proBono,
            proBonoCapacity: data.proBonoCapacity,
            proBonoCriteriaText: data.proBonoCriteriaText,
            additionalInfo: data.additionalInfo
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Show success message
          alert('Application submitted successfully! We\'ll review it and get back to you within 5-7 business days.');
          this.reset();
        } else {
          throw new Error(result.error || 'Failed to submit application');
        }
      } catch (error) {
        console.error('Error submitting application:', error);
        alert('There was an error submitting your application. Please try again or contact us directly.');
      }
    });
  </script>
    </div>
  </section>
  </AuthenticatedForm>
</Layout>