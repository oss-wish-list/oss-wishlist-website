---
import { getBasePath } from '../lib/paths';

const basePath = getBasePath();
---

<div id="authButtonContainer" class="flex items-center">
  <div class="h-8 w-px bg-gray-300 mr-6"></div>
  <div id="authButton" class="flex items-center space-x-3">
    <button class="text-gray-500 px-4 py-2 rounded-lg cursor-wait">
      Loading...
    </button>
  </div>
</div>

<script>
  const basePath = window.location.pathname.split('/').slice(0, 2).join('/') + '/oss-wishlist-website/';
  
  async function checkAuth() {
    try {
      const apiPath = basePath + 'api/auth/session';
      const response = await fetch(apiPath);
      
      if (response.ok) {
        const data = await response.json();
        if (data.authenticated && data.user) {
          showLogoutButton(data.user.login);
        } else {
          showLoginButton();
        }
      } else {
        showLoginButton();
      }
    } catch (error) {
      console.error('[AuthButton] Auth check failed:', error);
      showLoginButton();
    }
  }

  function showLoginButton() {
    const container = document.getElementById('authButton');
    if (container) {
      container.innerHTML = `
        <button onclick="window.location.href = '${basePath}api/auth/github'" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
          </svg>
          <span>Login</span>
        </button>
      `;
    }
  }

  function showLogoutButton(username) {
    const container = document.getElementById('authButton');
    if (container) {
      container.innerHTML = `
        <span class="text-sm text-gray-700">${username}</span>
        <button onclick="window.authLogout()" 
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
          </svg>
          <span>Logout</span>
        </button>
      `;
    }
  }

  window.authLogout = async function() {
    try {
      await fetch(basePath + 'api/auth/logout', { method: 'POST' });
      window.location.href = basePath.slice(0, -1);
    } catch (error) {
      console.error('[AuthButton] Logout failed:', error);
    }
  };

  // Check auth on page load
  checkAuth();
</script>
